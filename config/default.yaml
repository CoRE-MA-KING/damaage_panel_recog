# Default config (YAML).
# NOTE:
# - tracking.backend により使用するトラッキング実装が変わります。
# - tracking.distance は backend: distance のときだけ参照されます（motpy/noopでは無視されます）。
# - tracking.motpy は backend: motpy のときだけ参照されます（distance/noopでは無視されます）。

camera:
  device: /dev/video4
  capture:
    width: 800
    height: 600
    fps: 90
    fourcc: MJPG
  init_controls:
    auto_exposure: 1
    white_balance_automatic: 0

    exposure_time_absolute: 4
    gain: 0
    brightness: 0
    contrast: 32
    saturation: 90
    hue: 0
    gamma: 100
    power_line_frequency: 1
    white_balance_temperature: 4600
    sharpness: 3
    backlight_compensation: 0

detection:
  kernel_sz: 3
  width_tol: 0.4  # 上下LEDの幅一致割合（大きいLED側基準）
  min_h_overlap: 0.05  # 上下LEDの幅重なり具合（小さいLED側基準）
  min_v_gap: 10  # 上下LED最小距離
  min_box_h: 5  # LED最小高
  min_box_w: 10  # LED最小幅
  hsv:
    blue:
      H_low: 100
      H_high: 135
      S_low: 180
      S_high: 255
      V_low: 120
      V_high: 255
    red1:
      H_low: 0
      H_high: 15
    red2:
      H_low: 165
      H_high: 179
    redSV:
      S_low: 180
      S_high: 255
      V_low: 120
      V_high: 255

tracking:
  enabled: true

  # Select tracking backend:
  # - motpy    : motpy(SORT系) / IoUベースの割当
  # - distance : 自作 distance ベース（中心距離 + サイズ差）割当
  # - noop     : トラッキング無効（検出結果のみ扱う）
  backend: distance

  min_steps_alive: 2
  history_len: 20
  color_bgr: [0, 255, 255]

  # --------------------------------------------------------------------------
  # distance backend settings (ONLY used when backend: distance)
  # --------------------------------------------------------------------------
  distance:
    # 同一物体とみなす最大移動量（ピクセル）
    # 目安: 切り返しで 50px 程度でも分裂するなら、80pxなどに増やして調整
    gate_px: 80.0

    # 距離を正規化する手法
    # - diag     : bbox の対角長で割る（サイズ依存を緩和）
    # - sqrt_area: sqrt(w*h) で割る（サイズ依存を緩和）
    # - none     : 正規化しない（pxの絶対距離で評価）
    normalize: diag

    # bboxサイズ差のペナルティ重み（0で無視、上げるとサイズ一致を優先）
    # 外観情報がない代わりに w/h の変化で誤対応を抑える用途
    size_weight: 0.15

    # 予測（簡易定速度）を使うか
    # ONだと、前フレーム速度から予測した中心位置も候補に使う
    use_prediction: true

    # 速度更新の平滑化係数（0..1）
    # 1に近いほど最新の速度を強く反映（応答が鋭いがノイズにも敏感）
    vel_alpha: 0.6

    # 速度の上限（px/s）
    # 異常値で速度が暴れるのを防ぐ
    max_speed_px_s: 8000.0

    # 検出が欠落してもトラックを残すフレーム数（>=0）
    # 例: 90fps で 45 → 約 0.5s だけ保持
    max_age: 90

  # --------------------------------------------------------------------------
  # motpy settings (ONLY used when backend: motpy)
  # --------------------------------------------------------------------------
  motpy:
    order_pos: 2
    dim_pos: 2
    order_size: 0
    dim_size: 2
    q_var_pos: 5000.0
    r_var_pos: 0.1
    min_iou: null
    max_staleness: 4

publish:
  enabled: false
  key_prefix: ""
  publish_key: damagepanel

ui:
  window_name: "Panel (paired by same-color top & bottom)"
  fps_ema_alpha: 0.2
